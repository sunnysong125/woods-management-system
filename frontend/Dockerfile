# ğŸŒ³ Woods Management System - Frontend Dockerfile

# éšæ®µ1: å»ºæ§‹éšæ®µ
FROM node:18-alpine AS build-stage

WORKDIR /app

# è¤‡è£½ä¾è³´å®šç¾©æ–‡ä»¶
COPY package*.json ./

# å®‰è£ä¾è³´
RUN npm ci --only=production

# è¤‡è£½æºä»£ç¢¼
COPY . .

# å»ºæ§‹æ‡‰ç”¨
RUN npm run build

# éšæ®µ2: ç”Ÿç”¢éšæ®µ
FROM nginx:1.25-alpine AS production-stage

# å®‰è£ curl ç”¨æ–¼å¥åº·æª¢æŸ¥
RUN apk add --no-cache curl

# è¤‡è£½è‡ªå®šç¾©nginxé…ç½®
COPY nginx.conf /etc/nginx/nginx.conf

# è¤‡è£½å»ºæ§‹å¥½çš„æ‡‰ç”¨
COPY --from=build-stage /app/dist /usr/share/nginx/html

# å‰µå»ºérootç”¨æˆ¶
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# è¨­ç½®æ­£ç¢ºçš„æ¬Šé™
RUN chown -R nextjs:nodejs /usr/share/nginx/html
RUN chown -R nextjs:nodejs /var/cache/nginx
RUN chown -R nextjs:nodejs /var/log/nginx
RUN chown -R nextjs:nodejs /etc/nginx/conf.d
RUN touch /var/run/nginx.pid
RUN chown -R nextjs:nodejs /var/run/nginx.pid

# åˆ‡æ›åˆ°érootç”¨æˆ¶
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/ || exit 1

# å•Ÿå‹•nginx
CMD ["nginx", "-g", "daemon off;"] 