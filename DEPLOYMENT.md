# WoodsCarbonSink éƒ¨ç½²æŒ‡å¼•

## ğŸš€ å°ˆæ¡ˆæ›´æ–°å…§å®¹

æœ¬æ¬¡æ›´æ–°ä¸»è¦åŒ…å«ï¼š

### âœ¨ æ–°åŠŸèƒ½
- **å°ˆæ¡ˆæ¬Šé™æ§åˆ¶**ï¼šæ·»åŠ äº† `created_by` å­—æ®µä¾†è¿½è¹¤å°ˆæ¡ˆå‰µå»ºè€…
- **åˆªé™¤æ¬Šé™ç®¡ç†**ï¼šå°ˆæ¡ˆå‰µå»ºè€…å’Œè¶…ç´šç®¡ç†è€…éƒ½å¯ä»¥åˆªé™¤å°ˆæ¡ˆ
- **æ¬Šé™æª¢æŸ¥å„ªåŒ–**ï¼šå‰ç«¯æ”¯æ´å¤šç¨®ç®¡ç†å“¡èº«ä»½é©—è­‰ï¼ˆ`is_superuser`, `is_staff`, `is_admin`, `role === 'ADMIN'`ï¼‰

### ğŸ”§ æŠ€è¡“æ”¹å‹•
- å¾Œç«¯æ¨¡å‹è®Šæ›´ï¼š`Project` æ¨¡å‹æ–°å¢ `created_by` å¤–éµ
- æ•¸æ“šåº«é·ç§»ï¼š`0005_add_created_by_to_project.py`
- API æ¬Šé™é‚è¼¯æ›´æ–°
- å‰ç«¯æ¬Šé™æª¢æŸ¥é‚è¼¯æ”¹é€²

## ğŸ“‹ éƒ¨ç½²æ­¥é©Ÿ

### 1. å‚™ä»½é‡è¦æ–‡ä»¶
åœ¨éƒ¨ç½²å‰ï¼Œè«‹å‚™ä»½ä»¥ä¸‹æ–‡ä»¶ï¼š
```bash
# ç”Ÿç”¢ç’°å¢ƒé…ç½®
backend/core/settings.py
# åª’é«”æ–‡ä»¶
backend/media/
# éœæ…‹æ–‡ä»¶
backend/static/
# æ•¸æ“šåº«ï¼ˆå¦‚æœæ˜¯æ–‡ä»¶å‹æ•¸æ“šåº«ï¼‰
```

### 2. å¾Œç«¯éƒ¨ç½²

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Git éƒ¨ç½²ï¼ˆæ¨è–¦ï¼‰
```bash
# åœ¨ç”Ÿç”¢æœå‹™å™¨ä¸Š
cd /path/to/production/
git pull origin master

# å®‰è£ä¾è³´ï¼ˆå¦‚æœ‰æ–°å¢ï¼‰
pip install -r backend/requirements.txt

# åŸ·è¡Œæ•¸æ“šåº«é·ç§»
cd backend
python manage.py migrate trees

# æ”¶é›†éœæ…‹æ–‡ä»¶
python manage.py collectstatic --noinput

# é‡å•Ÿæœå‹™
systemctl restart your-django-service
```

#### æ–¹æ³•äºŒï¼šæ–‡ä»¶æ›¿æ›éƒ¨ç½²
å¦‚æœä½¿ç”¨æ–‡ä»¶æ›¿æ›ï¼Œè«‹åªæ›¿æ›ä»¥ä¸‹æ–‡ä»¶ï¼š
```bash
backend/trees/models.py
backend/trees/serializers.py
backend/trees/views.py
backend/trees/migrations/0005_add_created_by_to_project.py
```

ç„¶å¾ŒåŸ·è¡Œï¼š
```bash
cd backend
python manage.py migrate trees
systemctl restart your-django-service
```

### 3. å‰ç«¯éƒ¨ç½²

å‰ç«¯æœ‰é‡è¦æ›´æ–°ï¼Œéœ€è¦é‡æ–°æ§‹å»ºï¼š

```bash
# åœ¨é–‹ç™¼ç’°å¢ƒæˆ–CI/CDä¸­
cd frontend
npm install
npm run build

# å°‡ dist/ ç›®éŒ„å…§å®¹éƒ¨ç½²åˆ°Webæœå‹™å™¨
# ä¾‹å¦‚ï¼šnginx çš„ html ç›®éŒ„
```

### 4. é©—è­‰éƒ¨ç½²

éƒ¨ç½²å®Œæˆå¾Œï¼Œè«‹é©—è­‰ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **ç™»å…¥åŠŸèƒ½**ï¼šç¢ºä¿ç”¨æˆ¶å¯ä»¥æ­£å¸¸ç™»å…¥
2. **å°ˆæ¡ˆåˆ—è¡¨**ï¼šæª¢æŸ¥å°ˆæ¡ˆåˆ—è¡¨æ˜¯å¦æ­£å¸¸é¡¯ç¤º
3. **æ–°å¢å°ˆæ¡ˆ**ï¼šæ¸¬è©¦å°ˆæ¡ˆå‰µå»ºåŠŸèƒ½
4. **åˆªé™¤æ¬Šé™**ï¼š
   - å°ˆæ¡ˆå‰µå»ºè€…æ‡‰è©²èƒ½çœ‹åˆ°è‡ªå·±å°ˆæ¡ˆçš„åˆªé™¤æŒ‰éˆ•
   - è¶…ç´šç®¡ç†è€…æ‡‰è©²èƒ½çœ‹åˆ°æ‰€æœ‰å°ˆæ¡ˆçš„åˆªé™¤æŒ‰éˆ•
   - å…¶ä»–ç”¨æˆ¶ä¸æ‡‰è©²çœ‹åˆ°åˆªé™¤æŒ‰éˆ•
5. **APIæ¬Šé™**ï¼šä½¿ç”¨APIæ¸¬è©¦å·¥å…·é©—è­‰åˆªé™¤æ¬Šé™

## ğŸ”’ æ¬Šé™èªªæ˜

### å‰ç«¯æ¬Šé™æª¢æŸ¥
```javascript
// æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ï¼ˆä»»ä¸€ç¨®ï¼‰
isAdmin = user.is_superuser || user.is_staff || user.is_admin || user.role === 'ADMIN'

// æª¢æŸ¥æ˜¯å¦å¯ä»¥åˆªé™¤å°ˆæ¡ˆ
canDelete = isAdmin || project.created_by_id === currentUserId
```

### å¾Œç«¯æ¬Šé™æª¢æŸ¥
- **æŸ¥çœ‹å°ˆæ¡ˆ**ï¼šæ‰€æœ‰äºº
- **å‰µå»ºå°ˆæ¡ˆ**ï¼šå·²ç™»å…¥ç”¨æˆ¶
- **æ›´æ–°å°ˆæ¡ˆ**ï¼šå·²ç™»å…¥ç”¨æˆ¶
- **åˆªé™¤å°ˆæ¡ˆ**ï¼šè¶…ç´šç®¡ç†è€… OR å°ˆæ¡ˆå‰µå»ºè€…

## ğŸš¨ æ³¨æ„äº‹é …

1. **æ•¸æ“šåº«é·ç§»**ï¼šå¿…é ˆåŸ·è¡Œé·ç§»ï¼Œå¦å‰‡æœƒå‡ºç¾éŒ¯èª¤
2. **ç¾æœ‰å°ˆæ¡ˆ**ï¼šç¾æœ‰å°ˆæ¡ˆçš„ `created_by` ç‚º `NULL`ï¼Œåªæœ‰è¶…ç´šç®¡ç†è€…å¯ä»¥åˆªé™¤
3. **CSRF è¨­å®š**ï¼šç¢ºä¿ç”Ÿç”¢ç’°å¢ƒçš„ `CSRF_TRUSTED_ORIGINS` åŒ…å«æ­£ç¢ºçš„åŸŸå
4. **ç’°å¢ƒè®Šæ•¸**ï¼šæª¢æŸ¥æ‰€æœ‰ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºè¨­å®š

## ğŸ› å¸¸è¦‹å•é¡Œ

### 403 éŒ¯èª¤
å¦‚æœé‡åˆ° CSRF 403 éŒ¯èª¤ï¼Œæª¢æŸ¥ `settings.py` ä¸­çš„ï¼š
```python
CSRF_TRUSTED_ORIGINS = [
    'https://srv.orderble.com.tw',
    'http://srv.orderble.com.tw',
]
```

### å‰ç«¯ç„¡æ³•çœ‹åˆ°åˆªé™¤æŒ‰éˆ•
ç¢ºèªï¼š
1. ç”¨æˆ¶å·²æ­£ç¢ºç™»å…¥
2. ç”¨æˆ¶æ¬Šé™è¨­å®šæ­£ç¢º
3. å°ˆæ¡ˆçš„ `created_by_id` æ­£ç¢ºè¿”å›

### æ•¸æ“šåº«éŒ¯èª¤
å¦‚æœé‡åˆ°æ¬„ä½ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼ŒåŸ·è¡Œï¼š
```bash
python manage.py migrate trees --fake-initial
python manage.py migrate trees
```

## ğŸ“ æ”¯æ´

å¦‚æœéƒ¨ç½²éç¨‹ä¸­é‡åˆ°å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š
1. æœå‹™å™¨æ—¥èªŒ
2. Django éŒ¯èª¤æ—¥èªŒ
3. ç¶²çµ¡ç€è¦½å™¨æ§åˆ¶å°éŒ¯èª¤

## ğŸ“ æ›´æ–°æ—¥èªŒ

**2025-06-03**
- æ·»åŠ å°ˆæ¡ˆå‰µå»ºè€…è¿½è¹¤åŠŸèƒ½
- å¯¦æ–½ç²¾ç´°åŒ–æ¬Šé™æ§åˆ¶
- ä¿®å¾©å‰ç«¯æ¬Šé™æª¢æŸ¥é‚è¼¯
- å„ªåŒ–ç”¨æˆ¶é«”é©— 